# nLocalModels Dockerfile (Zig/Mojo LLM Inference Server)
# Formerly nOpenaiServer - now consolidated as nLocalModels
# 
# Version Requirements:
#   - Zig: 0.15.2 (matches local development)
#   - Mojo: 0.26.1 (uses bundled mojo-sdk)
FROM debian:bookworm-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    curl \
    xz-utils \
    git \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install Zig 0.15.2 (matches local development environment)
# Note: Filename format is zig-x86_64-linux-VERSION (not zig-linux-x86_64-VERSION)
WORKDIR /tmp
RUN curl -L https://ziglang.org/download/0.15.2/zig-x86_64-linux-0.15.2.tar.xz -o zig.tar.xz \
    && tar -xf zig.tar.xz \
    && mv zig-x86_64-linux-0.15.2 /usr/local/zig \
    && ln -s /usr/local/zig/zig /usr/local/bin/zig \
    && zig version

# Install Mojo 0.26.1 via magic CLI (optional - if fails, build continues with Zig only)
# Magic CLI requires specific environment setup that may not work in all Docker contexts
RUN curl -ssL https://magic.modular.com/install.sh | bash || echo "Magic CLI installation skipped"
ENV PATH="/root/.modular/bin:/root/.magic/bin:${PATH}"
RUN magic install mojo==0.26.1 2>/dev/null || magic install mojo 2>/dev/null || echo "Mojo installation skipped - building Zig components only"

WORKDIR /app

# Copy source (updated path to nLocalModels)
# IMPORTANT: Includes local mojo-sdk for consistent builds
COPY src/serviceCore/nLocalModels/ ./

# Verify versions match development environment
RUN echo "=== Build Environment ===" && \
    echo "Zig version: $(zig version)" && \
    echo "Mojo version: $(mojo --version)" && \
    echo "======================="

# Build Zig components
RUN zig build -Doptimize=ReleaseFast

# Build Mojo components using bundled mojo-sdk (if Mojo is available)
# The mojo-sdk directory contains our custom SDK build
RUN if [ -d "mojo" ] && command -v mojo >/dev/null 2>&1; then \
    echo "Building Mojo components with local SDK..." && \
    cd mojo && \
    mojo build main.mojo -o ../zig-out/bin/nlocalmodels-mojo 2>/dev/null || echo "Mojo build skipped"; \
    else \
    echo "Mojo not available or mojo directory not found - skipping Mojo components"; \
    fi

# Runtime image
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

RUN useradd -m -u 1000 appuser
WORKDIR /app

# Copy binaries
COPY --from=builder /app/zig-out/bin/* /app/

# Create models directory
RUN mkdir -p /app/models && chown -R appuser:appuser /app

USER appuser

EXPOSE 11434

HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=30s \
  CMD curl -sf http://localhost:11434/health || exit 1

CMD ["./nlocalmodels"]

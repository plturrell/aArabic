# nLocalModels Dockerfile - Simple Zig 0.15.1 Build
# Use stock Zig 0.15.1 to build nLocalModels service

# =============================================================================
# Stage 1: Build nLocalModels Service
# =============================================================================
FROM debian:bookworm-slim AS service-builder

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

ARG ZIG_VERSION=0.15.1
ARG TARGETARCH

# Install build dependencies
RUN apt-get update && apt-get install -y \
    curl \
    xz-utils \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install Zig (matching architecture)
WORKDIR /tmp
RUN case "$TARGETARCH" in \
        "amd64") ZIG_ARCH="x86_64" ;; \
        "arm64") ZIG_ARCH="aarch64" ;; \
        *) echo "Unsupported TARGETARCH: $TARGETARCH" && exit 1 ;; \
    esac && \
    curl -L "https://ziglang.org/download/${ZIG_VERSION}/zig-${ZIG_ARCH}-linux-${ZIG_VERSION}.tar.xz" -o zig.tar.xz && \
    tar -xf zig.tar.xz && \
    mv zig-${ZIG_ARCH}-linux-${ZIG_VERSION} /usr/local/zig && \
    rm zig.tar.xz

ENV PATH="/usr/local/zig:${PATH}"

# Copy SDK and service source code
WORKDIR /app
COPY src/nLang/ ./nLang/
COPY src/serviceCore/nLocalModels/ ./serviceCore/nLocalModels/

# Build nLocalModels CLI
WORKDIR /app/serviceCore/nLocalModels
RUN echo "=== Building nLocalModels CLI ===" && \
    ls -la && \
    test -f build.zig || (echo "ERROR: build.zig not found" && exit 1) && \
    zig version && \
    { zig build --release=fast 2>&1 | tee /tmp/zig-build.log; build_status=${PIPESTATUS[0]}; \
      if [[ ${build_status} -ne 0 ]]; then \
          echo "=== Zig build failed (exit ${build_status}) ==="; \
          tail -n 200 /tmp/zig-build.log || true; \
          echo "=== zig-cache (top level) ==="; \
          find zig-cache -maxdepth 2 -type f -print || true; \
          exit ${build_status}; \
      fi; }; \
    ls -la zig-out/bin/ && \
    test -f zig-out/bin/nlocalmodels || (echo "ERROR: nlocalmodels not built" && exit 1) && \
    echo "âœ“ nLocalModels CLI built successfully"

# =============================================================================
# Stage 2: Minimal Runtime Image
# =============================================================================
FROM debian:bookworm-slim

# Install minimal runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN useradd -m -u 1000 appuser
WORKDIR /app

# Copy service binaries from Stage 1
COPY --from=service-builder /app/serviceCore/nLocalModels/zig-out/bin/* /app/

# Create models directory
RUN mkdir -p /app/models && chown -R appuser:appuser /app

USER appuser

EXPOSE 11434

HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=30s \
  CMD pgrep nlocalmodels || exit 1

# Use CLI tool with model argument
CMD ["./nlocalmodels", "--model", "/app/models/qwen2.5-0.5b-instruct-q4_k_m.gguf", "--prompt", "Hello", "--max-tokens", "10"]

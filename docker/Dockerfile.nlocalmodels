# nLocalModels Dockerfile (Zig/Mojo LLM Inference Server)
# Formerly nOpenaiServer - now consolidated as nLocalModels
# 
# Uses custom SDK base image with pre-built n-c-sdk (Zig) and n-python-sdk (Mojo)
FROM plturrell/nservices:sdk-base AS builder

# Copy service source code
WORKDIR /app
COPY src/serviceCore/nLocalModels/ ./

# Verify SDKs are available
RUN echo "=== nLocalModels Build Environment ===" && \
    zig version && \
    echo "======================================"

# Build Zig components using custom n-c-sdk
RUN zig build -Doptimize=ReleaseFast

# Build Mojo components using custom n-python-sdk (if available)
RUN if command -v mojo >/dev/null 2>&1 && [ -d "mojo" ]; then \
    echo "Building Mojo components with custom n-python-sdk..." && \
    cd mojo && \
    mojo build main.mojo -o ../zig-out/bin/nlocalmodels-mojo || echo "Mojo build failed - continuing with Zig only"; \
    else \
    echo "Mojo not available or mojo directory not found - building Zig components only"; \
    fi

# =============================================================================
# Runtime Image
# =============================================================================
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

RUN useradd -m -u 1000 appuser
WORKDIR /app

# Copy binaries from builder
COPY --from=builder /app/zig-out/bin/* /app/

# Create models directory
RUN mkdir -p /app/models && chown -R appuser:appuser /app

USER appuser

EXPOSE 11434

HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=30s \
  CMD curl -sf http://localhost:11434/health || exit 1

CMD ["./nlocalmodels"]
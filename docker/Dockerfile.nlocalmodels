# nLocalModels Dockerfile (Zig/Mojo LLM Inference Server)
# Uses pre-built custom SDK images from separate repositories

# =============================================================================
# Pull Custom SDKs from Docker Hub
# =============================================================================
FROM plturrell/n-c-sdk:latest AS zig-sdk
FROM plturrell/n-python-sdk:latest AS mojo-sdk

# =============================================================================
# Build Stage
# =============================================================================
FROM debian:bookworm-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# Copy custom Zig SDK
COPY --from=zig-sdk /usr/local/zig /usr/local/zig
ENV PATH="/usr/local/zig/bin:${PATH}"
ENV ZIG_LIB_DIR="/usr/local/zig/lib"

# Copy custom Mojo SDK (optional)
COPY --from=mojo-sdk /usr/local/mojo /usr/local/mojo
COPY --from=mojo-sdk /usr/local/n-python-sdk-source /usr/local/n-python-sdk-source
ENV PATH="/usr/local/mojo/bin:${PATH}"

# Verify SDKs
RUN echo "=== nLocalModels Build Environment ===" && \
    zig version && \
    echo "======================================"

# Copy service source code
WORKDIR /app
COPY src/serviceCore/nLocalModels/ ./

# Build Zig components
RUN zig build -Doptimize=ReleaseFast

# Build Mojo components (if available)
RUN if command -v mojo >/dev/null 2>&1 && [ -d "mojo" ]; then \
    echo "Building Mojo components..." && \
    cd mojo && \
    mojo build main.mojo -o ../zig-out/bin/nlocalmodels-mojo || \
    echo "Mojo build failed - continuing with Zig only"; \
    else \
    echo "Mojo not available - building Zig components only"; \
    fi

# =============================================================================
# Runtime Image
# =============================================================================
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

RUN useradd -m -u 1000 appuser
WORKDIR /app

# Copy binaries from builder
COPY --from=builder /app/zig-out/bin/* /app/

# Create models directory
RUN mkdir -p /app/models && chown -R appuser:appuser /app

USER appuser

EXPOSE 11434

HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=30s \
  CMD curl -sf http://localhost:11434/health || exit 1

CMD ["./nlocalmodels"]
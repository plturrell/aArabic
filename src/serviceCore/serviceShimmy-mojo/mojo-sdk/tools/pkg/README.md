# Mojo Package Manager (`mojo-pkg`)

A modern, workspace-aware package manager for Mojo projects, seamlessly integrating with Zig's build system.

## ğŸš€ Features

- **ğŸ“¦ Package Management** - Initialize, install, and manage dependencies
- **ğŸ¢ Workspace Support** - Multi-package monorepo management
- **ğŸ”§ Zig Integration** - Automatic build.zig and build.zig.zon generation
- **âš¡ Fast Resolution** - Intelligent dependency resolution with conflict detection
- **ğŸ¯ Path Dependencies** - First-class support for local workspace members
- **ğŸ”’ Version Constraints** - Semantic versioning with flexible constraints (^, >=, exact)

## ğŸ“‹ Table of Contents

- [Installation](#installation)
- [Quick Start](#quick-start)
- [Commands](#commands)
- [Standalone Projects](#standalone-projects)
- [Workspace Projects](#workspace-projects)
- [Configuration](#configuration)
- [Examples](#examples)
- [Architecture](#architecture)

## ğŸ› ï¸ Installation

### Build from Source

```bash
cd src/serviceCore/serviceShimmy-mojo/mojo-sdk/tools/pkg
zig build
```

The executable will be at `zig-out/bin/mojo-pkg` (1.5M).

### Install to System

```bash
# Copy to a location in your PATH
sudo cp zig-out/bin/mojo-pkg /usr/local/bin/
```

## âš¡ Quick Start

### Create a New Package

```bash
# Initialize a new Mojo package
mojo-pkg init my-project

# This creates:
# mojo.toml - Package manifest
```

### Add Dependencies

```bash
# Add a dependency from a registry
mojo-pkg add http-client ^1.0.0

# Install all dependencies
mojo-pkg install
```

### Build and Test

```bash
# Build in debug mode
mojo-pkg build

# Build in release mode
mojo-pkg build --release

# Run tests
mojo-pkg test
```

## ğŸ“– Commands

### `init <name>`

Initialize a new Mojo package.

```bash
mojo-pkg init my-package
```

**Creates:**
- `mojo.toml` with package metadata

**Output mojo.toml:**
```toml
[package]
name = "my-package"
version = "0.1.0"
authors = []

[dependencies]
```

### `install`

Install all dependencies listed in `mojo.toml`.

```bash
mojo-pkg install
```

**What it does:**
1. Reads `mojo.toml`
2. Resolves all dependencies (including transitive)
3. Detects version conflicts
4. Generates `build.zig.zon` for Zig integration
5. In workspace mode: coordinates across all members

**Workspace-aware:** Automatically detects if you're in a workspace and resolves dependencies across all members.

### `build [--release]`

Build the package.

```bash
# Debug build
mojo-pkg build

# Release build (optimized)
mojo-pkg build --release
```

**What it does:**
1. Reads `mojo.toml`
2. Generates `build.zig` if needed
3. Executes `zig build` with appropriate flags

### `test`

Run package tests.

```bash
mojo-pkg test
```

Executes `zig build test` for the current package.

### `add <name> <version>`

Add a dependency to `mojo.toml`.

```bash
# Add with version constraint
mojo-pkg add http-client ^1.0.0

# Add with exact version
mojo-pkg add logger 1.2.3

# Add with minimum version
mojo-pkg add utils >=2.0.0
```

After adding, run `mojo-pkg install` to fetch the dependency.

### `workspace new <name>`

Create a new workspace.

```bash
mojo-pkg workspace new my-workspace
```

**Creates:**
```toml
[workspace]
members = []
```

### `workspace list`

List all workspace members.

```bash
mojo-pkg workspace list
```

**Output:**
```
Workspace members (3):
  - mojo-sdk (mojo-sdk)
  - shimmy-llm (services/llm)
  - shimmy-rag (services/rag)
```

### `help`

Show help message.

```bash
mojo-pkg help
```

## ğŸ“¦ Standalone Projects

For standalone packages like `mojo-sdk`:

### Project Structure

```
mojo-sdk/
â”œâ”€â”€ mojo.toml          # Package manifest
â”œâ”€â”€ build.zig          # Generated by mojo-pkg build
â”œâ”€â”€ build.zig.zon      # Generated by mojo-pkg install
â”œâ”€â”€ src/
â”‚   â””â”€â”€ mojo.zig
â””â”€â”€ tests/
    â””â”€â”€ test.zig
```

### Example mojo.toml

```toml
[package]
name = "mojo-sdk"
version = "0.1.0"
authors = ["Your Name <you@example.com>"]
description = "Core Mojo SDK"
license = "MIT"

[dependencies]
http-client = "^1.0.0"
json-parser = ">=2.0.0"
```

### Workflow

```bash
# 1. Initialize
mojo-pkg init mojo-sdk

# 2. Add dependencies
mojo-pkg add http-client ^1.0.0
mojo-pkg add json-parser >=2.0.0

# 3. Install
mojo-pkg install
# â†’ Resolves dependencies
# â†’ Creates build.zig.zon

# 4. Build
mojo-pkg build
# â†’ Creates build.zig
# â†’ Runs zig build

# 5. Test
mojo-pkg test
```

## ğŸ¢ Workspace Projects

For monorepos like `serviceShimmy-mojo`:

### Workspace Structure

```
serviceShimmy-mojo/
â”œâ”€â”€ mojo.toml          # Workspace manifest
â”œâ”€â”€ mojo-sdk/
â”‚   â”œâ”€â”€ mojo.toml      # Package manifest
â”‚   â””â”€â”€ src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”œâ”€â”€ mojo.toml  # Package manifest
â”‚   â”‚   â””â”€â”€ src/
â”‚   â””â”€â”€ rag/
â”‚       â”œâ”€â”€ mojo.toml  # Package manifest
â”‚       â””â”€â”€ src/
â””â”€â”€ inference/
    â”œâ”€â”€ mojo.toml      # Package manifest
    â””â”€â”€ src/
```

### Workspace mojo.toml

```toml
[workspace]
members = [
    "mojo-sdk",
    "services/llm",
    "services/rag",
    "inference"
]
```

### Member with Path Dependency

**services/llm/mojo.toml:**
```toml
[package]
name = "shimmy-llm"
version = "0.1.0"

[dependencies]
mojo-sdk = { path = "../../mojo-sdk" }
http-client = "^1.0.0"
```

### Workspace Workflow

```bash
# 1. Create workspace root
cd serviceShimmy-mojo
mojo-pkg workspace new shimmy-workspace

# 2. Initialize each member
cd mojo-sdk && mojo-pkg init mojo-sdk
cd ../services/llm && mojo-pkg init shimmy-llm
cd ../services/rag && mojo-pkg init shimmy-rag

# 3. Add dependencies (including path deps)
cd services/llm
mojo-pkg add mojo-sdk path:../../mojo-sdk
mojo-pkg add http-client ^1.0.0

# 4. Install from workspace root
cd ../..
mojo-pkg install
# â†’ Detects workspace
# â†’ Resolves all members
# â†’ Handles path dependencies
# â†’ Unifies resolutions
# â†’ Detects conflicts across workspace

# 5. Build workspace
mojo-pkg build
# â†’ Generates unified build.zig
# â†’ Coordinates member builds
```

## âš™ï¸ Configuration

### Version Constraints

- **Caret (`^`)**: Compatible updates
  - `^1.2.3` â†’ `>=1.2.3 <2.0.0`
  - `^0.2.3` â†’ `>=0.2.3 <0.3.0`
  
- **Greater than or equal (`>=`)**: Minimum version
  - `>=1.0.0` â†’ Any version 1.0.0 or higher
  
- **Exact**: Specific version only
  - `1.2.3` â†’ Exactly version 1.2.3

### Dependency Sources

**Registry (default):**
```toml
[dependencies]
http-client = "^1.0.0"
```

**Path (workspace members):**
```toml
[dependencies]
mojo-sdk = { path = "../../mojo-sdk" }
```

**Git (future):**
```toml
[dependencies]
some-lib = { git = "https://github.com/user/lib.git", tag = "v1.0.0" }
```

## ğŸ’¡ Examples

### Example 1: Simple Library

```bash
# Create library
mojo-pkg init math-utils

# No dependencies needed
mojo-pkg build
```

**mojo.toml:**
```toml
[package]
name = "math-utils"
version = "1.0.0"

[dependencies]
```

### Example 2: Service with Dependencies

```bash
# Create service
mojo-pkg init web-service

# Add dependencies
mojo-pkg add http-server ^2.0.0
mojo-pkg add json-parser ^1.0.0
mojo-pkg add logger ^0.5.0

# Install and build
mojo-pkg install
mojo-pkg build --release
```

**mojo.toml:**
```toml
[package]
name = "web-service"
version = "0.1.0"

[dependencies]
http-server = "^2.0.0"
json-parser = "^1.0.0"
logger = "^0.5.0"
```

### Example 3: Workspace with Shared SDK

```bash
# Create workspace
mkdir my-workspace && cd my-workspace
mojo-pkg workspace new my-workspace

# Create SDK
mkdir sdk && cd sdk
mojo-pkg init my-sdk
cd ..

# Create services that use SDK
mkdir services && cd services

mkdir api && cd api
mojo-pkg init api-service
mojo-pkg add my-sdk path:../../sdk
cd ..

mkdir worker && cd worker
mojo-pkg init worker-service
mojo-pkg add my-sdk path:../../sdk
cd ../..

# Install all
mojo-pkg install
```

**Structure:**
```
my-workspace/
â”œâ”€â”€ mojo.toml (workspace)
â”œâ”€â”€ sdk/
â”‚   â””â”€â”€ mojo.toml (my-sdk)
â””â”€â”€ services/
    â”œâ”€â”€ api/
    â”‚   â””â”€â”€ mojo.toml (api-service, depends on my-sdk)
    â””â”€â”€ worker/
        â””â”€â”€ mojo.toml (worker-service, depends on my-sdk)
```

## ğŸ—ï¸ Architecture

### Module Overview

```
mojo-pkg
â”œâ”€â”€ manifest.zig       - TOML parsing, version handling
â”œâ”€â”€ workspace.zig      - Workspace detection & management
â”œâ”€â”€ resolver.zig       - Dependency resolution & conflict detection
â”œâ”€â”€ zig_bridge.zig     - Zig build.zig generation
â”œâ”€â”€ cli.zig            - Command implementations
â””â”€â”€ main.zig           - Entry point
```

### Data Flow

```
User Command
    â†“
CLI Parser
    â†“
Command Handler
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Manifest       â”‚ â†’ Parse mojo.toml
â”‚  (manifest.zig) â”‚ â†’ Version parsing
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Workspace      â”‚ â†’ Detect workspace
â”‚ (workspace.zig) â”‚ â†’ Load members
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Resolver       â”‚ â†’ Build dep graph
â”‚ (resolver.zig)  â”‚ â†’ Resolve versions
â”‚                 â”‚ â†’ Detect conflicts
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Zig Bridge     â”‚ â†’ Generate build.zig
â”‚(zig_bridge.zig) â”‚ â†’ Generate .zon
â”‚                 â”‚ â†’ Execute zig build
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Result
```

### Key Design Decisions

1. **Workspace-Aware by Default**
   - Auto-detects workspace context
   - Seamlessly handles both standalone and workspace modes

2. **Zig Integration**
   - Generates idiomatic Zig build files
   - Leverages Zig's excellent build system

3. **Path Dependencies First**
   - Perfect for monorepo setups
   - Enables local development workflow

4. **Zero-Config Build**
   - Sensible defaults
   - Minimal configuration needed

## ğŸ§ª Testing

The package manager includes comprehensive tests:

```bash
# Run all tests
cd tools/pkg
zig build test
```

**Test Coverage:**
- 53/53 tests passing (100%)
- Manifest parsing
- Workspace detection
- Dependency resolution
- Build generation
- CLI parsing

## ğŸ¯ Use Cases

### Use Case 1: mojo-sdk (Standalone)

The core Mojo SDK as a standalone package:
- No workspace
- External dependencies only
- Builds as a library

### Use Case 2: serviceShimmy-mojo (Workspace)

The full service ecosystem:
- Workspace with multiple members
- Shared mojo-sdk dependency (path)
- Services depend on SDK
- Coordinated builds

### Use Case 3: inference/ (Central Service)

The inference service at workspace center:
- Part of larger workspace
- Depends on mojo-sdk (path)
- Has own external dependencies
- Builds as executable

## ğŸ”® Future Enhancements

- [ ] Registry support (publish/fetch packages)
- [ ] Git dependencies
- [ ] Lock file (mojo.lock)
- [ ] Parallel dependency downloads
- [ ] Cache management
- [ ] Offline mode
- [ ] Dependency tree visualization
- [ ] Update command
- [ ] Security audit

## ğŸ“ License

Part of the Mojo project. See project license.

## ğŸ¤ Contributing

See CONTRIBUTING.md in the project root.

## ğŸ“š Further Reading

- [Zig Build System](https://ziglang.org/documentation/master/#Build-System)
- [Semantic Versioning](https://semver.org/)
- [TOML Specification](https://toml.io/)

---

**Built with â¤ï¸ for the Mojo ecosystem**

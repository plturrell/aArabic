#!/usr/bin/env bash
# Git pre-commit hook for nExtract
# Runs formatting and basic checks before allowing commits

set -e

echo "ğŸ” Running pre-commit checks for nExtract..."

# Change to nExtract directory
cd "$(git rev-parse --show-toplevel)/src/serviceCore/nExtract" || exit 1

# Check if Zig is installed
if ! command -v zig &> /dev/null; then
    echo "âŒ Zig is not installed. Please install Zig 0.13+ to continue."
    exit 1
fi

# Run Zig formatter
echo "ğŸ“ Checking Zig code formatting..."
cd zig
if ! zig fmt --check .; then
    echo "âŒ Code formatting check failed!"
    echo "ğŸ’¡ Run 'zig fmt .' to fix formatting issues."
    exit 1
fi

# Run quick build check
echo "ğŸ”¨ Running build check..."
if ! zig build --summary failures 2>&1 | grep -q "Build Summary:"; then
    echo "âŒ Build check failed!"
    echo "ğŸ’¡ Fix build errors before committing."
    exit 1
fi

# Run tests if they exist
if [ -f "build.zig" ]; then
    echo "ğŸ§ª Running tests..."
    if ! zig build test --summary failures; then
        echo "âŒ Tests failed!"
        echo "ğŸ’¡ Fix failing tests before committing."
        exit 1
    fi
fi

cd ..

echo "âœ… Pre-commit checks passed!"
exit 0

name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Run tests
      run: |
        pytest --cov=backend --cov-report=xml

    - name: Lint with ruff
      run: |
        pip install ruff
        ruff check backend/ || true

  mojo-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true  # Mojo tests are optional until setup is stable

    steps:
    - uses: actions/checkout@v4

    - name: Cache Mojo installation
      uses: actions/cache@v4
      with:
        path: |
          ~/.modular
          ~/.magic
        key: ${{ runner.os }}-mojo-${{ hashFiles('src/serviceCore/nOpenaiServer/tools/toolorchestra/**/*.mojo') }}
        restore-keys: |
          ${{ runner.os }}-mojo-

    - name: Install Mojo via magic CLI
      run: |
        set -euo pipefail
        # Install magic CLI if not already installed
        if ! command -v magic &> /dev/null; then
          curl -ssL https://magic.modular.com/install.sh | bash
        fi
        # Add magic to PATH for this job
        export PATH="$HOME/.modular/bin:$HOME/.magic/bin:$PATH"
        echo "$HOME/.modular/bin" >> $GITHUB_PATH
        echo "$HOME/.magic/bin" >> $GITHUB_PATH
        # Install mojo if needed
        magic install mojo || echo "Mojo installation skipped or already present"

    - name: Verify Mojo installation
      run: |
        export PATH="$HOME/.modular/bin:$HOME/.magic/bin:$PATH"
        mojo --version || echo "Mojo not available"

    - name: Run toolorchestra Mojo tests
      working-directory: src/serviceCore/nOpenaiServer
      run: |
        set -euo pipefail
        export PATH="$HOME/.modular/bin:$HOME/.magic/bin:$PATH"

        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  Running toolorchestra Mojo tests"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        # Run each test file
        for test_file in tests/toolorchestra/test_*.mojo; do
          if [ -f "$test_file" ]; then
            echo ""
            echo "ğŸ§ª Running: $test_file"
            mojo run "$test_file" || {
              echo "âŒ Test failed: $test_file"
              exit 1
            }
            echo "âœ… Passed: $test_file"
          fi
        done

        echo ""
        echo "ğŸ‰ All toolorchestra Mojo tests passed"


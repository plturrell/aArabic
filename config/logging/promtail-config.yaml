# Promtail Configuration for LLM Server Log Shipping
# Day 6: Ship structured JSON logs to Loki
#
# This configuration:
# - Watches LLM server log files
# - Parses JSON structured logs
# - Extracts labels from log fields
# - Ships to Loki for aggregation

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # LLM Server Logs
  - job_name: llm-server
    static_configs:
      - targets:
          - localhost
        labels:
          job: llm-server
          __path__: /var/log/llm-server/*.log
    
    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            service: service
            environment: environment
            request_id: request_id
            trace_id: trace_id
            model: model
            operation: operation
      
      # Extract labels from parsed JSON
      - labels:
          level:
          service:
          environment:
          model:
          operation:
      
      # Set timestamp from log entry
      - timestamp:
          source: timestamp
          format: UnixMs
      
      # Output formatted message
      - output:
          source: message

  # KV Cache Specific Logs
  - job_name: kv-cache
    static_configs:
      - targets:
          - localhost
        labels:
          job: kv-cache
          component: tiered_cache
          __path__: /var/log/llm-server/kv-cache-*.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            service: service
            operation: operation
      
      - labels:
          level:
          operation:
      
      - timestamp:
          source: timestamp
          format: UnixMs

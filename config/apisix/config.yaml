# APISIX Configuration - Private Network Mode
# Configured for Keycloak OIDC authentication

apisix:
  node_listen: 9080
  enable_ipv6: false
  enable_admin: false  # Disabled for security in production

  # SSL Configuration
  ssl:
    enable: true
    listen:
      - port: 9443
        enable_http2: true

deployment:
  role: data_plane
  role_data_plane:
    config_provider: yaml

# Standalone mode - no etcd required
standalone:
  enabled: true

# Enable required plugins
plugins:
  - cors
  - proxy-rewrite
  - response-rewrite
  - limit-req
  - limit-count
  - limit-conn
  - ip-restriction
  - ua-restriction
  - referer-restriction
  - consumer-restriction
  - jwt-auth
  - key-auth
  - basic-auth
  - openid-connect
  - authz-keycloak
  - wolf-rbac
  - prometheus
  - zipkin
  - request-id
  - real-ip
  - redirect
  - gzip

# Plugin attributes
plugin_attr:
  prometheus:
    export_uri: /apisix/prometheus/metrics
    export_addr:
      ip: 127.0.0.1
      port: 9091

  openid-connect:
    # Token cache for performance
    token_signing_alg_values_expected: "RS256"
    set_access_token_header: true
    access_token_in_authorization_header: true
    set_id_token_header: true
    set_userinfo_header: true

# Global rules applied to all routes
global_rules:
  # Request ID for tracing
  - id: request-id
    plugins:
      request-id:
        include_in_response: true

  # Rate limiting (global)
  - id: rate-limit
    plugins:
      limit-req:
        rate: 100
        burst: 50
        key: remote_addr
        rejected_code: 429
        rejected_msg: "Rate limit exceeded"

# Nginx HTTP configuration
nginx_config:
  error_log_level: warn
  http:
    access_log_format: |
      {"time": "$time_iso8601", "remote_addr": "$remote_addr", "request": "$request", "status": $status, "body_bytes_sent": $body_bytes_sent, "request_time": $request_time, "upstream_response_time": "$upstream_response_time"}

    # Security headers
    custom_lua_shared_dict:
      session_storage: 20m

    real_ip_header: X-Forwarded-For
    real_ip_from:
      - 127.0.0.1
      - 10.0.0.0/8
      - 172.16.0.0/12
      - 192.168.0.0/16
